---
import ThemedPage from '../../layouts/themed-page.astro';
import { initCMS, getAnnouncements } from '../../lib/webflow-cms';

export const prerender = false;

// Initialize CMS with Cloudflare runtime context
initCMS(Astro.locals);

// Fetch announcements from CMS
let announcements: any[] = [];
try {
  const result = await getAnnouncements();
  announcements = result.items;
} catch (error) {
  console.error('Error fetching announcements:', error);
}

// Format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Priority badge colors
const priorityColors: Record<string, string> = {
  high: 'bg-red-500/20 text-red-400',
  normal: 'bg-blue-500/20 text-blue-400',
  low: 'bg-slate-500/20 text-slate-400'
};

// Strip HTML tags for preview text
const stripHtml = (html: string | undefined) => {
  if (!html) return '';
  return html.replace(/<[^>]*>/g, '').trim();
};
---

<ThemedPage title="Announcements | Jewett Junction" theme="dark" currentSection="dashboard">
  <div>
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-white mb-2">Company Announcements</h1>
        <p class="text-slate-400">Stay updated with the latest news and updates</p>
      </div>
      <a href="/jewett-junction/dashboard" class="inline-flex items-center gap-2 text-slate-400 hover:text-blue-400 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Dashboard
      </a>
    </div>

    {announcements.length === 0 ? (
      <div class="glass rounded-2xl p-12 text-center border border-slate-800/50">
        <svg class="w-12 h-12 text-slate-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
        </svg>
        <p class="text-slate-400">No announcements available</p>
      </div>
    ) : (
      <div class="space-y-4">
        {announcements.map((announcement) => (
          <a
            href={`/jewett-junction/announcements/${announcement.slug}`}
            class="block glass rounded-2xl p-6 border border-slate-800/50 hover:border-blue-500/30 transition-all group"
          >
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  {announcement['is-pinned'] && (
                    <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium bg-amber-500/20 text-amber-400 rounded-full">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" />
                      </svg>
                      Pinned
                    </span>
                  )}
                  <span class={`inline-block px-2 py-1 text-xs font-medium rounded-full ${priorityColors[announcement.priority] || priorityColors.normal}`}>
                    {announcement.priority || 'normal'}
                  </span>
                </div>
                <h2 class="text-xl font-semibold text-white group-hover:text-blue-400 transition-colors mb-2">
                  {announcement.name}
                </h2>
                <p class="text-slate-400 line-clamp-2">{stripHtml(announcement.content)}</p>
                <div class="flex items-center gap-4 mt-4 text-sm text-slate-500">
                  {announcement.author && (
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      {announcement.author}
                    </span>
                  )}
                  <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {formatDate(announcement['published-date'])}
                  </span>
                </div>
              </div>
              <svg class="w-5 h-5 text-slate-500 group-hover:text-blue-400 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    )}
  </div>
</ThemedPage>
