---
import ThemedPage from '../../layouts/themed-page.astro';
import { initCMS, getEventBySlug, getEvents, decodeHtmlEntities } from '../../lib/webflow-cms';

export const prerender = false;

// Initialize CMS with Cloudflare runtime context
initCMS(Astro.locals);

const { slug } = Astro.params;

// Fetch the event by slug
let event: any = null;
let relatedEvents: any[] = [];

try {
  if (slug) {
    event = await getEventBySlug(slug);

    // Also fetch related/upcoming events
    const result = await getEvents({ upcoming: true, limit: 4 });
    relatedEvents = result.items.filter(e => e.slug !== slug).slice(0, 3);
  }
} catch (error) {
  console.error('Error fetching event:', error);
}

// If event not found, return 404
if (!event) {
  return Astro.redirect('/jewett-junction/events');
}

// Format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatTime = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
};
---

<ThemedPage title={`${event.name} | Events | Jewett Junction`} theme="dark" currentSection="events">
  <div>
    <!-- Back link -->
    <a href="/jewett-junction/events" class="inline-flex items-center gap-2 text-slate-400 hover:text-blue-400 mb-6 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Events
    </a>

    <!-- Event Header -->
    <div class="glass rounded-2xl overflow-hidden mb-8 border border-slate-800/50">
      <!-- Banner Image -->
      {event['banner-image']?.url && (
        <div class="h-64 w-full overflow-hidden relative">
          <img src={event['banner-image'].url} alt={`Banner image for ${event.name}`} class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 to-transparent"></div>
        </div>
      )}

      <div class="p-8">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div>
            <div class="flex flex-wrap items-center gap-2 mb-3">
              {event.category && (
                <span class="inline-block px-3 py-1 text-xs font-medium bg-blue-500/20 text-blue-400 rounded-full">
                  {event.category}
                </span>
              )}
              {event['is-mandatory'] && (
                <span class="inline-block px-3 py-1 text-xs font-medium bg-red-500/20 text-red-400 rounded-full border border-red-500/30">
                  Mandatory
                </span>
              )}
              {event['is-virtual'] && (
                <span class="inline-block px-3 py-1 text-xs font-medium bg-purple-500/20 text-purple-400 rounded-full">
                  Virtual Event
                </span>
              )}
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-white">{event.name}</h1>
          </div>
        </div>

        <!-- Event Details -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="flex items-center gap-3 text-slate-300">
            <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-slate-400">Date</p>
              <p class="font-medium">{formatDate(event['event-date'])}</p>
            </div>
          </div>

          <div class="flex items-center gap-3 text-slate-300">
            <div class="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center">
              <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div>
              <p class="text-sm text-slate-400">Time</p>
              <p class="font-medium">{formatTime(event['event-date'])}</p>
            </div>
          </div>

          {event.location && (
            <div class="flex items-center gap-3 text-slate-300">
              <div class="w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-slate-400">Location</p>
                <p class="font-medium">{event.location}</p>
              </div>
            </div>
          )}

          {event['end-date'] && (
            <div class="flex items-center gap-3 text-slate-300">
              <div class="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
              </div>
              <div>
                <p class="text-sm text-slate-400">End Date</p>
                <p class="font-medium">{formatDate(event['end-date'])}</p>
              </div>
            </div>
          )}
        </div>

        <!-- Description -->
        {event.description && (
          <div class="prose prose-invert max-w-none mb-6">
            <h2 class="text-xl font-semibold text-white mb-3">About This Event</h2>
            <div class="text-slate-300 leading-relaxed" set:html={decodeHtmlEntities(event.description)} />
          </div>
        )}

        <!-- Capacity Info -->
        {event.capacity && (
          <div class="mb-6 p-4 bg-slate-800/50 rounded-xl">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <span class="text-slate-300">Capacity: <strong class="text-white">{event.capacity} attendees</strong></span>
            </div>
          </div>
        )}

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4">
          {event['registration-link'] && (
            <a
              href={event['registration-link']}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-xl transition-colors"
            >
              Register for Event
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          )}
          {event['virtual-link'] && (
            <a
              href={event['virtual-link']}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-medium rounded-xl transition-colors"
            >
              Join Virtual Event
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
            </a>
          )}

          <!-- Add to Calendar Dropdown -->
          <div class="relative" id="calendar-dropdown-container">
            <button
              id="calendar-dropdown-btn"
              class="inline-flex items-center gap-2 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-xl transition-colors"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Add to Calendar
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <div id="calendar-dropdown-menu" class="hidden absolute top-full left-0 mt-2 w-56 bg-slate-800 border border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden">
              <div class="p-2">
                <a
                  id="google-calendar-link"
                  href="#"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-3 px-3 py-2.5 text-sm text-slate-300 hover:bg-slate-700 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/>
                  </svg>
                  Google Calendar
                </a>
                <a
                  id="outlook-calendar-link"
                  href="#"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="flex items-center gap-3 px-3 py-2.5 text-sm text-slate-300 hover:bg-slate-700 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.5 2H2.5C1.67 2 1 2.67 1 3.5v17c0 .83.67 1.5 1.5 1.5h19c.83 0 1.5-.67 1.5-1.5v-17c0-.83-.67-1.5-1.5-1.5zM8 19H4V8h4v11zm6 0h-4V8h4v11zm6 0h-4V8h4v11z"/>
                  </svg>
                  Outlook Calendar
                </a>
                <button
                  id="download-ics-btn"
                  class="w-full flex items-center gap-3 px-3 py-2.5 text-sm text-slate-300 hover:bg-slate-700 rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Download .ics File
                </button>
              </div>
            </div>
          </div>
        </div>

        <script is:inline define:vars={{ eventData: { name: event.name, description: event.description || '', location: event.location || '', startDate: event['event-date'], endDate: event['end-date'] || null } }}>
          // Calendar utility functions (inline for Astro)
          function formatDateForGoogle(date) {
            return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
          }

          function formatDateForICS(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
          }

          function stripHtml(html) {
            return html.replace(/<[^>]*>/g, '').trim();
          }

          function escapeICS(text) {
            return text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
          }

          const startDate = new Date(eventData.startDate);
          const endDate = eventData.endDate ? new Date(eventData.endDate) : new Date(startDate.getTime() + 60 * 60 * 1000);

          // Generate Google Calendar URL
          const googleParams = new URLSearchParams();
          googleParams.set('action', 'TEMPLATE');
          googleParams.set('text', eventData.name);
          googleParams.set('dates', `${formatDateForGoogle(startDate)}/${formatDateForGoogle(endDate)}`);
          if (eventData.description) googleParams.set('details', stripHtml(eventData.description));
          if (eventData.location) googleParams.set('location', eventData.location);
          const googleUrl = `https://calendar.google.com/calendar/render?${googleParams.toString()}`;

          // Generate Outlook URL
          const outlookParams = new URLSearchParams();
          outlookParams.set('path', '/calendar/action/compose');
          outlookParams.set('rru', 'addevent');
          outlookParams.set('subject', eventData.name);
          outlookParams.set('startdt', startDate.toISOString());
          outlookParams.set('enddt', endDate.toISOString());
          if (eventData.description) outlookParams.set('body', stripHtml(eventData.description));
          if (eventData.location) outlookParams.set('location', eventData.location);
          const outlookUrl = `https://outlook.office.com/calendar/0/deeplink/compose?${outlookParams.toString()}`;

          // Set up links
          document.getElementById('google-calendar-link').href = googleUrl;
          document.getElementById('outlook-calendar-link').href = outlookUrl;

          // Dropdown toggle
          const dropdownBtn = document.getElementById('calendar-dropdown-btn');
          const dropdownMenu = document.getElementById('calendar-dropdown-menu');

          dropdownBtn.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!document.getElementById('calendar-dropdown-container').contains(e.target)) {
              dropdownMenu.classList.add('hidden');
            }
          });

          // Download ICS file
          document.getElementById('download-ics-btn').addEventListener('click', () => {
            const uid = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}@jewettjunction.com`;
            const now = formatDateForICS(new Date());

            let ics = [
              'BEGIN:VCALENDAR',
              'VERSION:2.0',
              'PRODID:-//Jewett Junction//Events//EN',
              'CALSCALE:GREGORIAN',
              'METHOD:PUBLISH',
              'BEGIN:VEVENT',
              `UID:${uid}`,
              `DTSTAMP:${now}`,
              `DTSTART:${formatDateForICS(startDate)}`,
              `DTEND:${formatDateForICS(endDate)}`,
              `SUMMARY:${escapeICS(eventData.name)}`,
            ];

            if (eventData.description) {
              ics.push(`DESCRIPTION:${escapeICS(stripHtml(eventData.description))}`);
            }
            if (eventData.location) {
              ics.push(`LOCATION:${escapeICS(eventData.location)}`);
            }

            ics.push('END:VEVENT', 'END:VCALENDAR');

            const content = ics.join('\r\n');
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `${eventData.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            dropdownMenu.classList.add('hidden');
          });
        </script>
      </div>
    </div>

    <!-- Related Events -->
    {relatedEvents.length > 0 && (
      <div class="glass rounded-2xl p-6 border border-slate-800/50">
        <h2 class="text-xl font-semibold text-white mb-4">Upcoming Events</h2>
        <div class="grid gap-4">
          {relatedEvents.map((relatedEvent) => (
            <a
              href={`/jewett-junction/events/${relatedEvent.slug}`}
              class="flex items-center gap-4 p-4 rounded-xl hover:bg-slate-800/50 transition-colors group"
            >
              {relatedEvent['banner-image']?.url ? (
                <img src={relatedEvent['banner-image'].url} alt={relatedEvent.name} class="w-16 h-16 rounded-xl object-cover flex-shrink-0" />
              ) : (
                <div class="w-16 h-16 bg-slate-800 rounded-xl flex flex-col items-center justify-center flex-shrink-0">
                  <span class="text-xs text-slate-400">{new Date(relatedEvent['event-date']).toLocaleDateString('en-US', { month: 'short' })}</span>
                  <span class="text-lg font-bold text-blue-400">
                    {new Date(relatedEvent['event-date']).getDate()}
                  </span>
                </div>
              )}
              <div class="flex-1 min-w-0">
                <h3 class="font-medium text-white group-hover:text-blue-400 transition-colors truncate">
                  {relatedEvent.name}
                </h3>
                <p class="text-sm text-slate-400">
                  {formatDate(relatedEvent['event-date'])}
                </p>
              </div>
              <svg class="w-5 h-5 text-slate-500 group-hover:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</ThemedPage>
